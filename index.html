<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dino Game</title>
<style>
body { margin:0; overflow:hidden; background:#cceeff; position:relative; }
canvas { display:block; margin:auto; touch-action:none; }
#startBtn {
  position:absolute; bottom:20px; right:20px;
  padding:12px 24px; font-size:20px;
  z-index:1000; cursor:pointer;
  border:none; border-radius:5px; background:#4CAF50; color:white;
}
</style>
</head>
<body>
<canvas id="game"></canvas>
<button id="startBtn">START</button>

<script src="https://telegram.org/js/games.js"></script>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startBtn");
let gameStarted = false;
let gameOver = false;
let score = 0;
let gameSpeed = 3; // ускорено на 50%

// Фиксированное поле
const FIELD_WIDTH = 1200;
const FIELD_HEIGHT = 400;

// Масштабирование canvas под экран
canvas.width = FIELD_WIDTH;
canvas.height = FIELD_HEIGHT;
function scaleCanvas(){
    let scaleX = window.innerWidth / FIELD_WIDTH;
    let scaleY = window.innerHeight / FIELD_HEIGHT;
    let scale = Math.min(scaleX, scaleY);
    canvas.style.transform = `scale(${scale})`;
    canvas.style.transformOrigin = "top left";
}
window.addEventListener("resize", scaleCanvas);
scaleCanvas();

// Игровые объекты
let dino = { x:60, y:FIELD_HEIGHT-80, w:40, h:40, vy:0, jumping:false };
let obstacles = [];
let clouds = [];

// Создание облаков
for(let i=0;i<5;i++){
    clouds.push({
        x: Math.random()*FIELD_WIDTH,
        y: Math.random()*FIELD_HEIGHT*0.3,
        w: FIELD_HEIGHT*0.1,
        h: FIELD_HEIGHT*0.05,
        speed: Math.random()*0.5+0.2
    });
}

// Прыжок
function jump(){
    if(!dino.jumping){
        dino.vy = -18;
        dino.jumping = true;
    }
}
startBtn.addEventListener("click", ()=>{ startBtn.style.display="none"; gameStarted=true; });

// Генерация препятствий
function generateObstacles(){
    const maxObstacles = 4;
    while(obstacles.length < maxObstacles){
        let last = obstacles[obstacles.length-1];
        let minGap = dino.w*2 + Math.random()*dino.w*2; // расстояние < длины прыжка
        let newX = last ? last.x + last.w + minGap : FIELD_WIDTH;

        let types = [
            { w:30, h:60 },  // обычный
            { w:40, h:40 },  // низкий
            { w:20, h:80 },  // высокий
            { w:50, h:50 }   // широкий
        ];
        let type = types[Math.floor(Math.random()*types.length)];

        obstacles.push({
            x: newX,
            y: FIELD_HEIGHT - type.h - 20,
            w: type.w,
            h: type.h
        });
    }
}

// Основное обновление с delta time
let lastTime = 0;
function update(delta){
    if(!gameStarted || gameOver) return;

    // Динозавр
    dino.y += dino.vy * delta;
    dino.vy += 0.6 * delta;
    if(dino.y >= FIELD_HEIGHT - dino.h - 20){ dino.y = FIELD_HEIGHT - dino.h - 20; dino.jumping=false; }

    // Препятствия
    generateObstacles();
    obstacles.forEach(o => o.x -= gameSpeed * delta);
    obstacles = obstacles.filter(o => o.x + o.w > 0);

    // Коллизии
    for(let o of obstacles){
        if(dino.x < o.x + o.w && dino.x + dino.w > o.x &&
           dino.y < o.y + o.h && dino.y + dino.h > o.y){
            endGame();
        }
    }

    // Облака
    clouds.forEach(c => { c.x -= c.speed * delta; if(c.x+c.w<0) c.x=FIELD_WIDTH; });

    // Очки и ускорение
    score++;
    gameSpeed += 0.001 * delta;
}

// Рисование
function draw(){
    ctx.clearRect(0,0,FIELD_WIDTH,FIELD_HEIGHT);

    // Облака
    ctx.fillStyle="white";
    clouds.forEach(c=>ctx.fillRect(c.x,c.y,c.w,c.h));

    // Земля
    ctx.fillStyle="#654321";
    ctx.fillRect(0,FIELD_HEIGHT-20,FIELD_WIDTH,20);

    // Динозавр
    ctx.fillStyle="green";
    ctx.fillRect(dino.x,dino.y,dino.w,dino.h);

    // Препятствия
    ctx.fillStyle="red";
    obstacles.forEach(o=>ctx.fillRect(o.x,o.y,o.w,o.h));

    // Счёт
    ctx.fillStyle="black";
    ctx.font="20px Arial";
    ctx.fillText("Score: "+score,20,30);

    if(gameOver){
        ctx.fillStyle="black";
        ctx.font="30px Arial";
        ctx.fillText("Game Over! Score: "+score,FIELD_WIDTH/2 - 120,FIELD_HEIGHT/2);
    }
}

// Игровой цикл с delta time
function loop(timestamp){
    if(!lastTime) lastTime = timestamp;
    const delta = (timestamp - lastTime) / 16.67; // нормируем к 60 FPS
    lastTime = timestamp;

    update(delta);
    draw();
    if(!gameOver) requestAnimationFrame(loop);
}
loop();

// Конец игры
function endGame(){
    gameOver=true;
    // Отправка очков в Telegram
    try{
        if(window.TelegramGameProxy){
            TelegramGameProxy.sendGameScore(score,true);
        }
    } catch(e){
        console.error("Ошибка отправки очков:", e);
    }
}

// Управление
window.addEventListener("keydown", e=>{ if(e.code==="Space") jump(); });
window.addEventListener("touchstart", ()=>jump());
</script>
</body>
</html>
